<html>
<title>Turing Tarpit Simulator</title>
<script>

/* internal values for simulated computer */
var ins_pointer = 0; 			/* instruction pointer */
var dat_pointer = 0; 			/* data pointer */
var dat_pointer_changed = 0; 		/* bool set to 1 if data pointer has changed in the last step */
var dat_pointer_last_address = 0; 	/* address of data pointer in last step */
var ram_last_address = 0; 		/* address of RAM updated in last step */
var breakpoints = 1; 			/* bool set to 0 to ignore breakpoints */
var ram = new Array();			/* memory of virtual machine */
var jmp = new Array();			/* used as a stack to jump from one command to another */
var ins = null; 			/* current instruction from code */
var halt = false;			/* halts program ASAP */

/* objects that display data to the user */
var disp_code;
var disp_ram;
var disp_ins_pointer;
var disp_pointer = "<div id=disp_pointer>&#8658;</div>"; /* data pointer displayed in memory block */

/* highlight current instruction running on machine */
function code_highlight(inputEl, selStart, selEnd) {
	if (inputEl.setSelectionRange) {
		inputEl.focus();
		inputEl.setSelectionRange(selStart, selEnd);
	} else if (inputEl.createTextRange) {
		var range = inputEl.createTextRange();
		range.collapse(true);
		range.moveEnd('character', selEnd);
		range.moveStart('character', selStart);
		range.select();
 	}
}

/* turns breakpoints on and off */
function debug_toggle_breakpoints()
{
	var button = document.getElementById("dbg_status");
	if(breakpoints) {
		breakpoints=0;
		button.innerHTML='<img src="http://opentextbook.info/icons/32x32/bug_delete.png">';
	}else {
		breakpoints=1;
		button.innerHTML='<img src="http://opentextbook.info/icons/32x32/bug_add.png">';
	}
}

/* removes all breakpoints in source code */
function debug_remove_breakpoints()
{
	/* ask user for permission first */
	var ans = confirm("Permanently remove all breakpoints from code?");
	var code = document.getElementById("code");
	if(ans) { code.value = code.value.replace( /\*/g , '' ); }
}

/* test current code character - return true if it is an instruction */
/* tried to use regex on this and could not get it to work :( */
function tst_inst()
{
	if(ins == '+' ||  ins == '-' ||  ins == '>' ||  ins == '<' ||
	  ins == '*' ||  ins == '.' ||  ins == '[' ||  ins == ']' ||  ins == ',') {
		return true;
	}
	return false;
}

/* find next instruction in code and move instruction pointer to it */
function fnd_nxt_inst()
{
	do {
		if(ins_pointer > disp_code.value.length) { break; } /* must stop at end of code */
		update_ins_pointer(1);
		ins = disp_code.value.substring(ins_pointer-1,ins_pointer); /* get data at ins_pointer location */
	}while(!tst_inst());
	if(ins_pointer > disp_code.value.length) {
		alert("HALT: Program is Complete");
		halt = true;
		reset();
	}
	
	/* highlight code currently executing on screen */
	code_highlight(disp_code, ins_pointer-1, ins_pointer);
}

/* find previous instruction in code and move instruction pointer to it */
function fnd_prv_inst()
{
	ins_pointer--;
	while(ins_pointer >= 0)
	{
		ins = disp_code.value.substring(ins_pointer-1, ins_pointer); /* get data at ins_pointer location */
		if(tst_inst()) { return; }
		ins_pointer--;
	}
	if(ins_pointer == 0) {
		alert("SEGFAULT: Program could not find corresponding jump instruction");
		halt = true;
		reset();
	}
}

/* execute next instruction from input */
function exe_nxt_inst()
{
	var temp_count = 0; 
	fnd_nxt_inst();
	switch(ins)
	{
		case '+':
			ram_modify(dat_pointer, 1);
  			break;
		case '-':
			ram_modify(dat_pointer, -1);
  			break;
		case '>':
			dat_point_modify(1);
			break;
		case '<':
			dat_point_modify(-1);
			break;
		case '*': /* these are comments - a break from the standard language */
			if(breakpoints) { stop(); }
			break;
		case '.':
			print_mem();
			break;
		case '[':
			jump_fwd();
			break;
		case ']':
			jump_bak();
			break;
		case ',':
			break;
		default:
  			/* must be a comment :) */
	}
}

/* if byte at data pointer is = 0, jump forward to instruction after matching ']' command */
function jump_fwd()
{
	if(ram[dat_pointer] != 0) { return; }
	/* add this jump to stack */
	jmp.push('[');
	/* loop through code, pushing and popping stack until stack is empty */
	while(jmp.length > 0) {
		fnd_nxt_inst();
		if(ins == ']') { jmp.pop();
		} else if (ins == '[') { jmp.push(']'); }
	}
}

/* if byte at data pointer is != 0, jump back to instruction after matching '[' command */
function jump_bak()
{
	if(ram[dat_pointer] == 0) { return; }
	/* add this jump to stack */
	jmp.push(']');
	/* loop through code, pushing and popping stack until stack is empty */
	while(jmp.length > 0 && ins_pointer > 0) {
		fnd_prv_inst();
		if(ins == '[') { jmp.pop();
		} else if (ins == ']') { jmp.push(']'); }
	}
}

/*
	rewind code to beginning reset all memory locations
	this simulates rebooting the computer
*/
function reset()
{
	update_ins_pointer(0);
	dat_point_modify(0);
	ram_reset();
	ram_highlight_clear();
	dat_point_highlight();
	document.getElementById("output_disp").innerHTML = '';
	document.getElementById("addr_0").innerHTML = "0" + disp_pointer;
	dat_point_highlight_clear();
}

/* stop stepping through code on timer if breakpoints enabled */
function stop()
{
	halt = true;
}

/* run through program on timer, stopping at breakpoints if enabled */
function run()
{
	var total_steps = document.getElementById("code").value.length;
	while(ins_pointer <= total_steps && halt == false) { step_next(); }
}

/* step forward one instruction */
function step_next()
{
	//update_ins_pointer(1);
	exe_nxt_inst();
	dat_point_highlight();
}

/* more back one instruction - undoes work of previous instruction */
function step_back()
{
	update_ins_pointer(-1);
	dat_point_highlight();
}

/* update instruction pointer
	direction:
	
	1 increment pointer by one
	0 set pointer to 0
	-1 decrement pointer by one
*/
function update_ins_pointer(direction)
{
	if(direction < 0 && ins_pointer != 0 ) { ins_pointer--; }
	else if (direction == 0 ) { ins_pointer = 0; }
	else { ins_pointer++; }
	disp_ins_pointer.value =  ins_pointer;
}

/* setup virtual machine - must be called on page load */
function init_form()
{
	disp_code  = document.getElementById("code");
	disp_ins_pointer = document.getElementById("ins_pointer_disp");
	disp_ram = document.getElementById("ram_disp");
	ram_reset();
	ram_init();
	document.getElementById("addr_0").innerHTML = "0" + disp_pointer;
	/* reset_output(); */
}

/* reset all RAM to 0 */
function ram_reset()
{
	var i;
	for(i=0; i < 64; i++) { ram[i] = 0; }
}

/* update highlight of one memory address and release other highlight if needed */
function ram_highlight(address)
{
	var disp_last_address = document.getElementById("ram_"+ram_last_address);
	/* highlight background of current address */
	document.getElementById("ram_"+address).style.backgroundColor = "#ff0";

	/* remove highlight from last address modified */
	if(ram_last_address != address){
		if(ram_last_address%2==0) {
			disp_last_address.style.backgroundColor = "#fff";
		} else {
			disp_last_address.style.backgroundColor = "#def";
		}
	}
}

/* remove highlight from all memory cells regardless of current status */
function ram_highlight_clear()
{
	var i;
	for(i=0; i < 64; i++)
	{
		if(i%2==0) {
			document.getElementById("ram_"+i).style.backgroundColor = "#fff";
		} else {
			document.getElementById("ram_"+i).style.backgroundColor = "#def";
		}
		document.getElementById("ram_"+i).innerHTML = ram[i];
	}
}

/* define RAM on screen */
function ram_init()
{
	var i;
	var table = "<table id=memory_table>\n";
	for(i=0; i < 16; i++){
		if(i%2==0) {
			table += "\t<tr>";
		} else {
			table += "\t<tr class=odd>";
		}
		table += "<td width='35' class=addr id=addr_"+i+">"+i+"</td><td width='35' class=ram id=ram_"+i+">";
		table += ram[i]+"</td><td width='35' class=addr id=addr_"+(i+16)+">";
		table += (i+16)+"</td><td class=ram id=ram_"+(i+16)+">"+ram[i+16]+"</td>\n";
		table += "<td class=addr id=addr_"+(i+32)+">"+(i+32)+"</td><td width='35' class=ram id=ram_";
		table += (i+32)+">"+ram[i+32]+"</td><td class=addr id=addr_";
		table += (i+48)+">"+(i+48)+"</td><td width='35' class=ram id=ram_"+(i+48)+">"+ram[i+48]+"</td></tr>\n";
	}
	table +=  "</table>\n";
	disp_ram.innerHTML = table;
}

/*
	modify the value at this address - reset RAM highlights for all addresses
	1 increment RAM by one
	0 set RAM to 0
	-1 decrement RAM by one
*/
function ram_modify(address, change)
{
	if(address < 0 || address > 63) {
		alert("SEGFAULT: Cannot Modify Data Outside of Memory Range");
		halt = true;
		reset();
		return;
	}

	if (change > 0 ) {
		ram[address]++;
	} else if(change < 0 ) {
		ram[address]--;
	} else {
		ram[address] = 0;
	}
	ram_highlight(address);
	document.getElementById("ram_"+address).innerHTML = ram[address];
	ram_last_address = address;
}

/* modify state of data pointer */
function dat_point_modify(change)
{
	dat_pointer_last_address = dat_pointer;
	if (change > 0 ) {
		dat_pointer++;
	} else if(change < 0 ) {
		/* could put SEGFAULT here, but C does not have a check for this, so neither will I ;) */
		dat_pointer--;
	} else {
		dat_pointer = 0;
	}

	/* place '>' char next to memory address in table */
	if(dat_pointer >= 0 && dat_pointer < 64) {
		document.getElementById("addr_"+dat_pointer).innerHTML = dat_pointer + disp_pointer;
	}

	/* remove '>' char next to memory address in table */
	if(dat_pointer_last_address >= 0 && dat_pointer_last_address < 64) {
		document.getElementById("addr_"+dat_pointer_last_address).innerHTML = dat_pointer_last_address;
	}

	document.getElementById("dat_pointer_disp").value = dat_pointer;
	dat_pointer_changed = 1;
}

/* turns on and off data pointer highlight if it has changed this step */
function dat_point_highlight()
{
	var dat = document.getElementById("dat_pointer_disp");
	if(dat_pointer_changed) {
		dat.style.backgroundColor = "#ff0";
		dat_pointer_changed = 0;
	} else {
		dat.style.backgroundColor = "#fff";
	}

	/* as a convenience to the user, set to red if pointer is out of memory range */
	if(dat_pointer < 0 || dat_pointer > 63) {
		dat.style.backgroundColor = "#f00";
	}
}

/* remove highlight from data pointer */
function dat_point_highlight_clear()
{
	var dat = document.getElementById("dat_pointer_disp");
	dat.style.backgroundColor = "#fff";
}

/* print ASCII representation of memory at data pointer */
function print_mem()
{
	var x = String.fromCharCode(63+ram[dat_pointer]);
	document.getElementById("output_disp").innerHTML += x;
}

</script>

<style type="text/css">

body {
	font-family: Tahoma, Arial, Helvetica, sans-serif;
}

#disp_pointer {
	float:right;
	color: #f00;
}

#code_buttons {
	position: absolute;
	top: 570px;
	left: 10px;
}

#input_banner {
	position: absolute;
	top: 120px;
	left: 10px;
}

#da_banner {
	position: absolute;
	top: 450px;
	left: 625px;
}

#ip_banner {
	position: absolute;
	top: 400px;
	left: 625px;
}

#output_banner {
	position: absolute;
	top: 120px;
	left: 625px;
}

#memory_banner {
	position: absolute;
	top: 120px;
	left: 315px;
}

#input {
	position: absolute;
	top: 140px;
	left: 10px;
}	

#ram_disp {
	position: absolute;
	top: 140px;
	left: 315px;
}

#memory_table {
	border:1px solid #000;
	border-collapse: collapse;
}

td {
	padding: 5px;
	border-bottom:1px solid #000;
}

.odd {
	background-color: #def;
}
.odd td {
	border-bottom: 1px solid #000;
}

.addr {
	color: #00f;
}

.ram {
	border-right:1px solid #000;
}

#output {
	position: absolute;
	top: 140px;
	left: 625px;
}

#instruction {
	position: absolute;
	top: 425px;
	left: 625px;
}

#data {
	position: absolute;
	top: 475px;
	left: 625px;

}

</style>
<body onLoad="init_form();">

<center><h2>Turing Tarpit Simulator</h2></center>

<center>
<button onClick='reset();'><img src="http://opentextbook.info/icons/32x32/resultset_first.png"></button>
&nbsp;&nbsp;
<button onClick='step_back();'><img src="http://opentextbook.info/icons/32x32/resultset_previous.png"></button>
&nbsp;&nbsp;
<button onClick='step_next();'><img src="http://opentextbook.info/icons/32x32/resultset_next.png"></button>
&nbsp;&nbsp;
<button onClick='run();'><img src="http://opentextbook.info/icons/32x32/resultset_last.png"></button>
&nbsp;&nbsp;
<button onClick='halt();'><img src="http://opentextbook.info/icons/32x32/cancel.png"></button>
&nbsp;&nbsp;
<button disabled><img src="http://opentextbook.info/icons/32x32/disk.png"></button>
</center>

<div id="code_buttons">
<button id="dbg_status" onClick='debug_toggle_breakpoints();'>
	<img src="http://opentextbook.info/icons/32x32/bug_add.png">
</button>
&nbsp;&nbsp;
<button id="dbg_status" onClick='debug_remove_breakpoints();'>
	<img src="http://opentextbook.info/icons/32x32/bin.png">
</button>
</div>

<div id="input_banner">INPUT</div>
<div id="input"><textarea id="code" rows="27" cols="38"></textarea></div>

<div id="ip_banner">INSTRUCTION POINTER</div>
<div id="instruction"><input id="ins_pointer_disp" type="text" diabled value=0></div>

<div id="da_banner">DATA POINTER</div>
<div id="data"><input id="dat_pointer_disp" type="text" diabled value=0></div>

<div id="memory_banner">MEMORY</div>
<div id="ram_disp"></div>
<div id="output_banner">OUTPUT</div>
<div id="output">
<textarea name=code id=output_disp rows="15" cols="38" disabled ></textarea>
</div>

</body>
</html>

