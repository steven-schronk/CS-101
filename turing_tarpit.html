<html>
<title>Turing Tarpit Simulator</title>
<script>

/* internal values for simulated computer */
var ins_pointer = 0; 			/* instruction pointer */
var dat_pointer = 0; 			/* data pointer */
var dat_pointer_changed = 0; 		/* bool set to 1 if data pointer has changed in the last step */
var dat_pointer_last_address = 0; 	/* address of data pointer in last step */
var ram_last_address = 0; 		/* address of RAM updated in last step */
var breakpoints = 1; 			/* bool set to 0 to ignore breakpoints */
var ram = new Array();			/* memory of virtual machine */
var jmp = new Array();			/* used as a stack to jump from one command to another */
var ins = null; 			/* current instruction from code */
var halt = false;			/* halts program ASAP */

/* objects that display data to the user */
var disp_docs;
var disp_code;
var disp_ram;
var disp_ins_pointer;
var disp_dat_pointer;
var disp_pointer = "<div id=disp_pointer>&#8658;</div>"; /* data pointer displayed in memory block */

/* highlight current instruction running on machine */
function code_highlight(inputEl, selStart, selEnd) {
	if (inputEl.setSelectionRange) {
		inputEl.focus();
		inputEl.setSelectionRange(selStart, selEnd);
	} else if (inputEl.createTextRange) {
		var range = inputEl.createTextRange();
		range.collapse(true);
		range.moveEnd('character', selEnd);
		range.moveStart('character', selStart);
		range.select();
 	}
}

/* turns breakpoints on and off */
function debug_toggle_breakpoints()
{
	var button = document.getElementById("dbg_status");
	if(breakpoints) {
		breakpoints=0;
		button.innerHTML='<img src="http://opentextbook.info/icons/32x32/bug_delete.png">';
	}else {
		breakpoints=1;
		button.innerHTML='<img src="http://opentextbook.info/icons/32x32/bug_add.png">';
	}
}

/* removes all breakpoints in source code */
function debug_remove_breakpoints()
{
	/* ask user for permission first */
	var ans = confirm("Permanently remove all breakpoints from code?");
	var code = document.getElementById("code");
	if(ans) { code.value = code.value.replace( /\*/g , '' ); }
}

/* test current code character - return true if it is an instruction */
/* tried to use regex on this and could not get it to work :( */
function tst_inst()
{
	if(ins == '+' ||  ins == '-' ||  ins == '>' ||  ins == '<' ||
	  ins == '*' ||  ins == '.' ||  ins == '[' ||  ins == ']' ||  ins == ',') {
		return true;
	}
	return false;
}

/* find next instruction in code and move instruction pointer to it */
function fnd_nxt_inst()
{
	do {
		if(ins_pointer > disp_code.value.length) { break; } /* must stop at end of code */
		update_ins_pointer(1);
		ins = disp_code.value.substring(ins_pointer-1,ins_pointer); /* get data at ins_pointer location */
	}while(!tst_inst());
	if(ins_pointer > disp_code.value.length) {
		alert("HALT: Program is Complete");
		halt = true;
		reset();
	}
	
	/* highlight code currently executing on screen */
	code_highlight(disp_code, ins_pointer-1, ins_pointer);
}

/* find previous instruction in code and move instruction pointer to it */
function fnd_prv_inst()
{
	ins_pointer--;
	while(ins_pointer >= 0)
	{
		ins = disp_code.value.substring(ins_pointer-1, ins_pointer); /* get data at ins_pointer location */
		if(tst_inst()) { return; }
		ins_pointer--;
	}
	if(ins_pointer == 0) {
		alert("SEGFAULT: Program could not find corresponding jump instruction");
		halt = true;
		reset();
	}
}

/* execute next instruction from input */
function exe_nxt_inst()
{
	var temp_count = 0; 
	fnd_nxt_inst();
	switch(ins)
	{
		case '+':
			ram_modify(dat_pointer, 1);
  			break;
		case '-':
			ram_modify(dat_pointer, -1);
  			break;
		case '>':
			dat_point_modify(1);
			break;
		case '<':
			dat_point_modify(-1);
			break;
		case '*': /* these are comments - a break from the standard language */
			if(breakpoints) { stop(); }
			break;
		case '.':
			print_mem();
			break;
		case '[':
			jump_fwd();
			break;
		case ']':
			jump_bak();
			break;
		case ',':
			break;
		default:
  			/* must be a comment :) */
	}
}

/* if byte at data pointer is = 0, jump forward to instruction after matching ']' command */
function jump_fwd()
{
	if(ram[dat_pointer] != 0) { return; }
	/* add this jump to stack */
	jmp.push('[');
	/* loop through code, pushing and popping stack until stack is empty */
	while(jmp.length > 0) {
		fnd_nxt_inst();
		if(ins == ']') { jmp.pop();
		} else if (ins == '[') { jmp.push(']'); }
	}
}

/* if byte at data pointer is != 0, jump back to instruction after matching '[' command */
function jump_bak()
{
	if(ram[dat_pointer] == 0) { return; }
	/* add this jump to stack */
	jmp.push(']');
	/* loop through code, pushing and popping stack until stack is empty */
	while(jmp.length > 0 && ins_pointer > 0) {
		fnd_prv_inst();
		if(ins == '[') { jmp.pop();
		} else if (ins == ']') { jmp.push(']'); }
	}
}

/*
	rewind code to beginning reset all memory locations
	this simulates rebooting the computer
*/
function reset()
{
	update_ins_pointer(0);
	dat_point_modify(0);
	ram_reset();
	ram_highlight_clear();
	dat_point_highlight();
	document.getElementById("output_disp").innerHTML = '';
	document.getElementById("addr_0").innerHTML = "0" + disp_pointer;
	dat_point_highlight_clear();
}

/* stop stepping through code on timer if breakpoints enabled */
function stop()
{
	halt = true;
}

/* run through program on timer, stopping at breakpoints if enabled */
function run()
{
	var total_steps = document.getElementById("code").value.length;
	while(ins_pointer <= total_steps && halt == false) { step_next(); }
}

/* step forward one instruction */
function step_next()
{
	//update_ins_pointer(1);
	exe_nxt_inst();
	dat_point_highlight();
}

/* more back one instruction - undoes work of previous instruction */
function step_back()
{
	update_ins_pointer(-1);
	dat_point_highlight();
}

/* update instruction pointer
	direction:
	
	1 increment pointer by one
	0 set pointer to 0
	-1 decrement pointer by one
*/
function update_ins_pointer(direction)
{
	if(direction < 0 && ins_pointer != 0 ) { ins_pointer--; }
	else if (direction == 0 ) { ins_pointer = 0; }
	else { ins_pointer++; }
	disp_ins_pointer.value =  ins_pointer;
}

/* update instruction pointer and set to new value */
function ins_point_modify_by_address(val)
{
	/* instruction pointer can never be less than 0 */
	if(val < 0) {
		alert("Instruction Pointer cannot be set less than Zero.");
		disp_ins_pointer.value =  ins_pointer; /* reset val to previous */
		return;
	}
	if(val > disp_code.value.length) {
		alert("Instruction Pointer cannot be set beyond end of code.\n Current length of code: " + disp_code.value.length);
		disp_ins_pointer.value =  ins_pointer; /* reset val to previous */
		return;
	}
	ins_pointer = disp_ins_pointer.value;
}

/* setup virtual machine - must be called on page load */
function init_form()
{
	disp_code  = document.getElementById("code");
	disp_ins_pointer = document.getElementById("ins_pointer_disp");
	disp_dat_pointer = document.getElementById("dat_pointer_disp");
	disp_ram = document.getElementById("ram_disp");
	ram_reset();
	ram_init();
	document.getElementById("addr_0").innerHTML = "0" + disp_pointer;
	disp_docs = document.getElementById("docs");
	/* reset_output(); */
}

/* reset all RAM to 0 */
function ram_reset()
{
	var i;
	for(i=0; i < 64; i++) { ram[i] = 0; }
}

/* update highlight of one memory address and release other highlight if needed */
function ram_highlight(address)
{
	var disp_last_address = document.getElementById("ram_"+ram_last_address);
	/* highlight background of current address */
	document.getElementById("ram_"+address).style.backgroundColor = "#ff0";

	/* remove highlight from last address modified */
	if(ram_last_address != address){
		if(ram_last_address%2==0) {
			disp_last_address.style.backgroundColor = "#fff";
		} else {
			disp_last_address.style.backgroundColor = "#def";
		}
	}
}

/* remove highlight from all memory cells regardless of current status */
function ram_highlight_clear()
{
	var i;
	for(i=0; i < 64; i++)
	{
		if(i%2==0) {
			document.getElementById("ram_"+i).style.backgroundColor = "#fff";
		} else {
			document.getElementById("ram_"+i).style.backgroundColor = "#def";
		}
		document.getElementById("ram_"+i).innerHTML = ram[i];
	}
}

/* define RAM on screen */
function ram_init()
{
	var i;
	var table = "<table id=memory_table>\n";
	for(i=0; i < 16; i++){
		if(i%2==0) {
			table += "\t<tr class=even>";
		} else {
			table += "\t<tr class=odd>";
		}
		table += "<td width='35' class=addr id=addr_"+i+">"+i+"</td><td width='35' class=ram id=ram_"+i+">"+ram[i]+"</td>";
		table += "<td width='35' class=addr id=addr_"+(i+16)+">"+(i+16)+"</td><td class=ram id=ram_"+(i+16)+">"+ram[i+16]+"</td>\n";
		table += "<td class=addr id=addr_"+(i+32)+">"+(i+32)+"</td><td width='35' class=ram id=ram_"+(i+32)+">"+ram[i+32]+"</td>\n";
		table += "<td class=addr id=addr_"+(i+48)+">"+(i+48)+"</td><td width='35' class=ram id=ram_"+(i+48)+">"+ram[i+48]+"</td></tr>\n";
	}
	table +=  "</table>\n";
	disp_ram.innerHTML = table;
}

/*
	modify the value at this address - reset RAM highlights for all addresses
	1 increment RAM by one
	0 set RAM to 0
	-1 decrement RAM by one
*/
function ram_modify(address, change)
{
	if(address < 0 || address > 63) {
		alert("SEGFAULT: Cannot Modify Data Outside of Memory Range");
		halt = true;
		reset();
		return;
	}

	if (change > 0 ) {
		ram[address]++;
	} else if(change < 0 ) {
		ram[address]--;
	} else {
		ram[address] = 0;
	}
	ram_highlight(address);
	document.getElementById("ram_"+address).innerHTML = ram[address];
	ram_last_address = address;
}

/*
	modify state of data pointer
	1 increment data pointer by one
	0 set data pointer to 0
	-1 decrement data pointer by one

*/
function dat_point_modify(change)
{
	dat_pointer_last_address = dat_pointer;
	if (change > 0 ) {
		dat_pointer++;
	} else if(change < 0 ) {
		/* could put SEGFAULT here, but C does not have a check for this, so neither will I ;) */
		dat_pointer--;
	} else {
		dat_pointer = 0;
	}

	/* place '>' char next to memory address in table */
	if(dat_pointer >= 0 && dat_pointer < 64) {
		document.getElementById("addr_"+dat_pointer).innerHTML = dat_pointer + disp_pointer;
	}

	/* remove '>' char next to memory address in table */
	if(dat_pointer_last_address >= 0 && dat_pointer_last_address < 64) {
		document.getElementById("addr_"+dat_pointer_last_address).innerHTML = dat_pointer_last_address;
	}

	disp_dat_pointer.value = dat_pointer;
	dat_pointer_changed = 1;
}

function dat_point_modify_by_address(val)
{
	dat_pointer_last_address = dat_pointer;
	dat_pointer = disp_dat_pointer.value;
	/* place '>' char next to memory address in table */
	if(dat_pointer >= 0 && dat_pointer < 64) {
		document.getElementById("addr_"+dat_pointer).innerHTML = dat_pointer + disp_pointer;
	}

	/* remove '>' char next to memory address in table */
	if(dat_pointer_last_address >= 0 && dat_pointer_last_address < 64) {
		document.getElementById("addr_"+dat_pointer_last_address).innerHTML = dat_pointer_last_address;
	}
	dat_pointer_changed = 1;
	dat_point_highlight();
}

/* turns on and off data pointer highlight if it has changed this step */
function dat_point_highlight()
{
	if(dat_pointer_changed) {
		disp_dat_pointer.style.backgroundColor = "#ff0";
		dat_pointer_changed = 0;
	} else {
		disp_dat_pointer.style.backgroundColor = "#fff";
	}

	/* as a convenience to the user, set to red if pointer is out of memory range */
	if(dat_pointer < 0 || dat_pointer > 63) {
		disp_dat_pointer.style.backgroundColor = "#f00";
	}
}

/* remove highlight from data pointer */
function dat_point_highlight_clear()
{
	disp_dat_pointer.style.backgroundColor = "#fff";
}

/* print ASCII representation of memory at data pointer */
function print_mem()
{
	var x = String.fromCharCode(ram[dat_pointer]);
	document.getElementById("output_disp").innerHTML += x;
}

/* documentation stored inside invisible div. This shows its contents. */
function display_docs()
{
	disp_docs.style.visibility = "visible";
	docs_select("docs_main");
}

/* hide documentation from user */
function hide_docs()
{
	disp_docs.style.visibility = "hidden";
}

function docs_select(page)
{
	if(page == "basic") {
		document.getElementById("docs_content").innerHTML = document.getElementById("docs_basic").innerHTML;
	} else if(page == "features") {
		document.getElementById("docs_content").innerHTML = document.getElementById("docs_features").innerHTML;
	} else if(page == "examples") {
		document.getElementById("docs_content").innerHTML = document.getElementById("docs_examples").innerHTML;
	} else if(page == "examples2") {
		document.getElementById("docs_content").innerHTML = document.getElementById("docs_examples2").innerHTML;
	} else {
		document.getElementById("docs_content").innerHTML = document.getElementById("docs_main").innerHTML;
	}
}

</script>

<style type="text/css">

body {
	font-family: Tahoma, Arial, Helvetica, sans-serif;
}

#disp_pointer {
	float:right;
	color: #f00;
}

#code_buttons {
	position: absolute;
	top: 570px;
	left: 10px;
}

#input_banner {
	position: absolute;
	top: 120px;
	left: 10px;
}

#da_banner {
	position: absolute;
	top: 360px;
	left: 625px;
}

#ref_banner {
	position: absolute;
	top: 410px;
	left: 625px;
}

#ip_banner {
	position: absolute;
	top: 315px;
	left: 625px;
}

#output_banner {
	position: absolute;
	top: 120px;
	left: 625px;
}

#memory_banner {
	position: absolute;
	top: 120px;
	left: 315px;
}

#input {
	position: absolute;
	top: 140px;
	left: 10px;
}	

#ram_disp {
	position: absolute;
	top: 140px;
	left: 315px;
}

#memory_table {
	border:1px solid #000;
	border-collapse: collapse;
}

.even td {
	padding: 4px;
	border-bottom:1px solid #000;
}

.odd td {
	padding: 4px;
	background-color: #def;
	border-bottom: 1px solid #000;
}

.addr {
	color: #00f;
}

.ram {
	border-right:1px solid #000;
}

#output {
	position: absolute;
	top: 140px;
	left: 625px;
}

#docs {
	border:1px solid #000;
	background-color: #dfd;
	position: absolute;
	top: 10px;
	left: 10px;
	width: 1000px;
	height:700px;
	visibility: hidden;
}

#docs_top_banner {
	color: #fff;
	background-color: #88f;
	border-bottom:1px solid #000;
	position: absolute;
	top: 0px;
	left: 0px;
	height: 25px;
	padding-top: 5px;
	padding-left: 5px;
	width: 995px;
}

#docs_close_btn {
	background-color: #f00;
	border:3px solid #000;
	position: absolute;
	top: 0px;
	right: 0px;
	height: 25px;
	cursor: pointer;
}

#docs_mnu_btn {
	border:2px solid #000;
	background-color: #faa;
	color: #000;
	position: absolute;
	top: 0px;
	left: 375px;
	height: 25px;
	padding-top: 3px;
	padding-left: 20px;
	padding-right: 20px;
	cursor: pointer;
}

#docs_content {
	position: absolute;
	top: 35px;
	padding: 10px;
}

#docs_link:hover {
	background-color: #faa;
	cursor: pointer;

}

.docs_code_ex {
	background-color: #fff;
	border: 1px solid #ddd;
	padding: 5px;
}

.docs_hidden {
	visibility: hidden;
}

#instruction {
	position: absolute;
	top: 335px;
	left: 625px;
}

#data {
	position: absolute;
	top: 385px;
	left: 625px;
}

#reference {
	position: absolute;
	top: 430px;
	left: 625px;
	width: 280px;
}

</style>
<body onLoad="init_form();">

<center><h2>Turing Tarpit Simulator</h2></center>

<center>
<button onClick='reset();'><img src="http://opentextbook.info/icons/32x32/resultset_first.png"></button>
&nbsp;&nbsp;
<button onClick='step_back();'><img src="http://opentextbook.info/icons/32x32/resultset_previous.png"></button>
&nbsp;&nbsp;
<button onClick='step_next();'><img src="http://opentextbook.info/icons/32x32/resultset_next.png"></button>
&nbsp;&nbsp;
<button onClick='run();'><img src="http://opentextbook.info/icons/32x32/resultset_last.png"></button>
&nbsp;&nbsp;
<button onClick='halt();'><img src="http://opentextbook.info/icons/32x32/cancel.png"></button>
&nbsp;&nbsp;
<button disabled><img src="http://opentextbook.info/icons/32x32/disk.png"></button>
&nbsp;&nbsp;
<button onClick='display_docs();'><img src="http://opentextbook.info/icons/32x32/book_open.png"></button>
</center>

<div id="code_buttons">
<button id="dbg_status" onClick='debug_toggle_breakpoints();'>
	<img src="http://opentextbook.info/icons/32x32/bug_add.png">
</button>
&nbsp;&nbsp;
<button id="dbg_status" onClick='debug_remove_breakpoints();'>
	<img src="http://opentextbook.info/icons/32x32/bin.png">
</button>
</div>

<div id="input_banner">INPUT</div>
<div id="input"><textarea id="code" rows="27" cols="38"></textarea></div>

<div id="ip_banner">INSTRUCTION POINTER</div>
<div id="instruction"><input  onBlur="ins_point_modify_by_address(disp_ins_pointer.value);" id="ins_pointer_disp" type="text" diabled value=0></div>

<div id="da_banner">DATA POINTER</div>
<div id="data"><input onBlur="dat_point_modify_by_address(disp_dat_pointer.value);" id="dat_pointer_disp" type="text" diabled value=0></div>

<div id="ref_banner">INSTRUCTION REFERENCE</div>
<table id="reference">
	<tr><td>+</td><td>increment byte at data pointer</td></tr>
	<tr><td>-</td><td>decrement byte at data pointer</td></tr>
	<tr><td>></td><td>increment data pointer</td></tr>
	<tr><td><</td><td>decrement data pointer</td></tr>
	<tr><td>.</td><td>print byte at data pointer</td></tr>
	<tr><td>,</td><td>accept one byte of input</td></tr>
	<tr><td>*</td><td>set breakpoint</td></tr>
</table>

<div id="memory_banner">MEMORY</div>
<div id="ram_disp"></div>
<div id="output_banner">OUTPUT</div>
<div id="output">
<textarea name=code id=output_disp rows="10" cols="38" disabled ></textarea>
</div>
<div id="docs">
	<div id="docs_top_banner">
		Turing Tarpit Simulator Documentation&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<div id="docs_mnu_btn" onClick="docs_select('main');">Main Menu</div>
		<div id="docs_close_btn" onClick="hide_docs();">X</div></div>

	<div id="docs_content"></div>
</div>

<div id="docs_main" class="docs_hidden">
		<div id="docs_link" onClick="docs_select('basic');">Basic Operation</div>
		<div id="docs_link" onClick="docs_select('features');">Features and Hints</div>
		<div id="docs_link" onClick="docs_select('examples');">Example Code 1</div>
		<div id="docs_link" onClick="docs_select('examples2');">Example Code 2</div>
		
</div>

<div id="docs_basic" class="docs_hidden">

Basic

<p>This program is completely self contained in one HTML document.  You are free do use it how you wish, subject to the terms and conditions of the GNU GPL license (version 3).

<p>Although it has not been tested in all browsers, it should work well under most any modern web browser that supports Dynamic HTML and JavaScript.  You must have JavaScript enabled for this application to work properly.

<p>No server interaction or outside service is needed for this program to operate.

</div>

<div id="docs_features" class="docs_hidden">

Features and Hints

<p>All characters outside the Instruction Set are considered comments and will be skipped over during runtime.

<p>While program executes, the Input cursor is moved over the current instruction.

<p>User can change the address of the Data Pointer and Instruction Pointer at any time.
Memory and pointers that have been modified are highlighted in yellow until the next step.

<p>The Data Pointer can point to any location. If you de-reference a pointer out of memory range, a segfault error will occur. This causes the computer to reboot without warning.

<p>The Instruction Pointer can point to a location range of 1 to the number of characters in the input.

<p>Restarting the machine will reset all Memory, Data and Instruction Pointers to zero.

<p>The output of the program cannot be edited.

<p>A user can add a break instruction in the code using an asterisk '*'. This will cause the machine to pause when in Run Mode. Breaks can be disabled and enabled with the debug button, and can be permanently deleted with the delete button.

<p>In this version the programs you type in are not saved to your computer.  This must be done as a manual operation.

<p>As this program is reliant on the speed and efficiency of your browsers JavaScript implementation some computers will be able to execute programs faster than others.

</div>

<div id="docs_examples" class="docs_hidden">
These are some examples of programs and snippets to get you started. Click the "Load" button to apply these to the Input of the simulator. (Please Note: You will erase the current program stored there.) Many of these examples can be found at Wikipedia.

<p><b>Clear Byte:</b>
Sets value at current Data Pointer to Zero.
<div class=docs_code_ex>
[-]
</div>
<p><b>Clear Previous Cells:</b>
Sets value of all previous bytes including current byte to Zero.
<div class=docs_code_ex>
[[-]<]
</div>
<p><b>Rewind:</b>
Goes back to byte Zero.
<div class=docs_code_ex>
[<]>
</div>
<p><b>Fast-forward:</b>
Increments the data pointer until a 0 is found then decrements if until the current cell is non-zero.
<div class=docs_code_ex>
[>]<
</div>
<p><b>Simple Loop:</b>
Accepts input from the user and echos it to the screen, similar to the UNIX cat program.
<div class=docs_code_ex>
 ,[.,]
</div>
<p><b>Moving the Data Pointer:</b>
Accepts input from the user and saves all input in the memory for future use.
<div class=docs_code_ex>
 >,[.>,]
</div>
</div>


<div id="docs_examples2" class="docs_hidden">
<p><b>Add Two Bytes:</b>
Adds current location to the next location and leaves behind a Zero for the first value.
<div class=docs_code_ex>
[->+<]
</div>
<p><b>Lower To Upper:</b>
Accepts lower case input from the user and makes it uppercase. Stops when user presses the enter key.
<div class=docs_code_ex>
,----------[----------------------.,----------]
</div>
<p><b>Copy Value:</b>
Copy value of byte Zero to byte One.
<div class=docs_code_ex>
>[-]>[-]<<[->+>+<<]>>[-<<+>>]<<
</div>
<p><b>Seek:</b>
Move Data Pointer forward until it lands on a byte with a value of 1, preserving all bytes it passes.
<div class=docs_code_ex>
-[+>-]+
</div>
<p><b>Single Digit Add:</b>
Adds two single digit numbers and display result. Works on one-digit results only.
<div class=docs_code_ex>
,>++++++[<-------->-],[<+>-]<.
</div>
<p><b>Single Digit Multiplication:</b>
Multiply two single digit numbers and display result. Works on one-digit results only.
<div class=docs_code_ex>
 ,>,>++++++++[<------<------>>-]
 <<[>[>+>+<<-]>>[<<+>>-]<<<-]
 >>>++++++[<++++++++>-]<.>.
</div>
<p><b>Single Digit Division:</b>
Accepts two single-digit numbers from the user, divides them and displays the truncated quotient. Dividend is stored in byte Zero and Divisor is stored in byte One.
<div class=docs_code_ex>
,>,>++++++[-<--------<-------->>]<<[>[->+>+<<]>[-<<-[>]>>>[<[>>>-<<<[-]]>>]<<]>>>+<<[-<<+>>]<<<]>[-]>>>>[-<<<<<+>>>>>]<<<<++++++[-<++++++++>]<.
</div>
</div>
</body>
</html>

