<html>
<title>Turing Machine Simulator</title>
<script>

/* internal values for simulated computer */
var ins_pointer = 0; /* instruction pointer */
var dat_pointer = 0; /* data pointer */
var dat_pointer_last_address = 0; /* address of data pointer in last step */
var ram_last_address = 0; /* address of RAM updated in last step */
var ram = new Array();

/* objects that display data to the user */
var disp_code;
var disp_ram;
var disp_ins_pointer;

/* only allow turing machine chars in source box - all others ignored */
function char_check(e)
{
	e.value = e.value.replace( /9/g , '' );
	/* only allowed chars in input ><+-.,[] */
}

/* execute next instruction from input */
function exe_nxt_inst()
{
	var code = document.getElementById("code");
	var ins = null; /* current instruction from code */
	if(ins_pointer > code.value.length) {
		alert("HALT: Program is Complete");
		reset();
	}

	ins = code.value.substring(ins_pointer-1,ins_pointer); /* get data at ins_pointer location */

	switch(ins)
	{
		case '+':
			ram_modify(ins_pointer, 1);
  			break;
		case '-':
			ram_modify(ins_pointer, -1);
  			break;
		case '>':
			dat_point_modify(1);
			break;
		case '<':
			dat_point_modify(-1);
			break;
		default:
  			/* must be a comment :) */
	}

	/*
	alert(document.getElementById("code").value.length);
	alert(document.getElementById("code").value);
	alert(document.getElementById("code").value.substring(0,1));
	*/
}

/*
	rewind code to beginning reset all memory locations
	this simulates rebooting the computer
*/
function reset()
{
	update_ins_pointer(0);
	dat_point_modify(0);
	ram_reset();
	ram_highlight_clear();
	dat_point_highlight();
}

/* step forward one instruction */
function step_next()
{
	update_ins_pointer(1);
	exe_nxt_inst();
	dat_point_highlight();
}

/* more back one instruction - undoes work of previous instruction */
function step_back()
{
	update_ins_pointer(-1);
	dat_point_highlight();
}

/* update instruction pointer
	direction:
	
	1 increment pointer by one
	0 set pointer to 0
	-1 decrement pointer by one
*/
function update_ins_pointer(direction)
{
		if(direction < 0 && ins_pointer != 0 ) { ins_pointer--; }
		else if (direction == 0 ) { ins_pointer = 0; }
		else { ins_pointer++; }
		disp_ins_pointer.value =  ins_pointer;
}

/* setup virtual machine - must be called on page load */
function init_form()
{
	disp_code  = document.getElementById("code");
	disp_ins_pointer = document.getElementById("ins_pointer_disp");
	disp_ram = document.getElementById("ram_disp");
	ram_reset();
	ram_init();
	/* reset_output(); */
}

/* reset all RAM to 0 */
function ram_reset()
{
	var i;
	for(i=0; i < 64; i++) { ram[i] = 0; }
}

/* update background color of one memory address */
function ram_highlight(address)
{
	var disp_last_address  = document.getElementById("ram_"+ram_last_address);

	if(address%2==0) { /* will reset to original color of _stiped_ table */
		document.getElementById("ram_"+address).style.backgroundColor = "#ff0";
	} else {
		document.getElementById("ram_"+address).style.backgroundColor = "#de0";
	}

	if(disp_last_address) {
		if(ram_last_address%2==0) {
			disp_last_address.style.backgroundColor = "#fff";
		} else {
			disp_last_address.style.backgroundColor = "#def";
		}
	}
}

/* remove highlight from all memory cells regardless of current status */
function ram_highlight_clear()
{
	var i;
	for(i=0; i < 64; i++)
	{
		if(i%2==0) {
			document.getElementById("ram_"+i).style.backgroundColor = "#fff";
		} else {
			document.getElementById("ram_"+i).style.backgroundColor = "#def";
		}
		document.getElementById("ram_"+i).innerHTML = ram[i];
	}
}

/* define RAM on screen */
function ram_init()
{
	var i;
	var table = "<table id=memory_table><tr><td>A</td><td>V</td><td>A</td><td>V</td><td>A</td><td>V</td><td>A</td><td>V</td></tr>\n";
	for(i=0; i < 16; i++){
		if(i%2==0) {
			table += "\t<tr>";
		} else {
			table += "\t<tr class=odd>";
		}
		table += "<td>"+i+"</td><td id=ram_"+i+">"+ram[i]+"</td><td>"+(i+16)+"</td><td id=ram_"+(i+16)+">"+ram[i+16]+"</td>\n";
			table += "<td>"+(i+32)+"</td><td id=ram_"+(i+32)+">"+ram[i+32]+"</td><td>"+(i+48)+"</td><td id=ram_"+(i+48)+">"+ram[i+48]+"</td></tr>\n";
	}
	table +=  "</table>\n";
	disp_ram.innerHTML = table;
}

/* modify the value at this address - reset RAM highlights for all addresses
	1 inrement RAM by one
	0 set RAM to 0
	-1 decrement RAM by one
*/
function ram_modify(address, change)
{
	if(address < 0 || address > 63) {
		alert("SEGFAULT: Cannot Modify Data Outside of Memory Range");
		reset();
		return;
	}

	if (change > 0 ) {
		ram[address]++;
	} else if(change < 0 ) {
		ram[address]--;
	} else {
		ram[address] = 0;
	}
	ram_highlight(address);
	document.getElementById("ram_"+address).innerHTML = ram[address];
	ram_last_address = address;
}

/* modify state of data pointer */
function dat_point_modify(change)
{
	dat_pointer_last_address = dat_pointer;
	if (change > 0 ) {
		dat_pointer++;
	} else if(change < 0 ) {
		/* could put SEGFAULT here, but C does not have a check for this, so neither will I ;) */
		dat_pointer--;
	} else {
		dat_pointer = 0;
	}
	document.getElementById("dat_pointer_disp").value = dat_pointer;
}

/* turns on and off data pointer highlight if it has changed this step */
function dat_point_highlight()
{
	//alert(dat_pointer_last_address+"\t"+dat_pointer);
	if(dat_pointer_last_address != dat_pointer) {
		//alert("diff");
		document.getElementById("dat_pointer_disp").style.backgroundColor = "#ff0";
	} else {
		//alert("same");
		document.getElementById("dat_pointer_disp").style.backgroundColor = "#fff";
	}
}

</script>

<style type="text/css">

#input_banner {
	position: absolute;
	top: 120px;
	left: 110px;
}

#da_banner {
	position: absolute;
	top: 450px;
	left: 560px;
}

#ip_banner {
	position: absolute;
	top: 400px;
	left: 560px;
}

#output_banner {
	position: absolute;
	top: 120px;
	left: 600px;
}

#memory_banner {
	position: absolute;
	top: 120px;
	left: 355px;
}

#input {
	position: absolute;
	top: 140px;
	left: 10px;
}	

#ram_disp {
	position: absolute;
	top: 140px;
	left: 315px;
}

#memory_table {
	border:1px solid #000;
	border-collapse: collapse;
}

td {
	padding: 5px;
}

.odd {
	background-color: #def;
}
.odd td {
	border-bottom: 1px solid #cef;
}

#output {
	position: absolute;
	top: 140px;
	left: 550px;
}

#instruction {
	position: absolute;
	top: 425px;
	left: 550px;
}

#data {
	position: absolute;
	top: 475px;
	left: 550px;

}

</style>
<body onLoad="init_form();">

<center><h2>Turing Machine Simulator</h2></center>

<center>
<button name="step" onClick='reset();'><img src="http://opentextbook.info/icons/32x32/resultset_first.png"></button>
<button name="step" onClick='step_back();'><img src="http://opentextbook.info/icons/32x32/resultset_previous.png"></button>
<button name="step" onClick='step_next();'><img src="http://opentextbook.info/icons/32x32/resultset_next.png"></button>
<button name="step" disabled><img src="http://opentextbook.info/icons/32x32/resultset_last.png"></button>
<button name="step" onClick='reset();'><img src="http://opentextbook.info/icons/32x32/cancel.png"></button>
<button name="step" disabled><img src="http://opentextbook.info/icons/32x32/disk.png"></button>
</center>

<div id="input_banner">INPUT</div>
<div id="input"><textarea id="code" rows="25" cols="33" onKeyDown="char_check(this);"></textarea></div>

<div id="ip_banner">INSTRUCTION POINTER</div>
<div id="instruction"><input id="ins_pointer_disp" type="text" diabled value=0></div>

<div id="da_banner">DATA POINTER</div>
<div id="data"><input id="dat_pointer_disp" type="text" diabled value=0></div>

<div id="memory_banner">MEMORY</div>
<div id="ram_disp"></div>
<div id="output_banner">OUTPUT</div>
<div id="output">
<textarea name=code  rows="15" cols="30" disabled ></textarea>
</div>

</body>
</html>

